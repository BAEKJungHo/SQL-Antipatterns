# 순진한 트리

## 목표 : 계층구조 저장 및 조회하기

데이터가 재귀적 관계를 가지는 것은 흔한 일이다. 데이터는 트리나 계층적 구조가 될 수 있다. 트리 데이터 구조를 가지는 예에는 다음과 같은 것이 포함된다.

- `조직도`
  - 직원과 관리자의 관계
- `글타래`
  - 답글에 대한 답글

## 안티패턴

### 항상 부모에 의존하기

가장 초보적인 방법은 parent_id 컬럼을 추가해서 같은 테이블 안의 다른 글을 참조 시키는 것이다.

```sql
CREATE TABLE Comments (
  comment_id SERIAL PRIMARY KEY,
  parent_id BIGINT UNSIGNED,
  bug_id BIGNINT UNSIGNED NOT NULL,
  author BIGINT UNSSIGNED NOT NULL,
  comment_date DATETIME NOT NULL,
  comment TEXT NOT NULL,
  FOREIGN KEY (parent_id) REFERENCES Comments(comment_id),
  FOREIGN KEY (bug_id) REFERENCES Bugs(bug_id),
  FOREIGN KEY (author) REFERENCES Accounts(account_id)
);
```

이러한 설계를 `인접 목록(Adjacency List)` 이라 불린다.

#### 인접 목록에서 트리 조회하기

인접 목록은 많은 개발자들이 기본으로 선택하는 방법이지만, 트리에서 필요한 가장 흔한 작업 중 하나인 모든 자식 조회하기를 제대로 하지 못 한다면 안티패턴이 될 수 있다.

- 답글과 그 답글의 바로 아래 자식 얻기

```sql
SELECT c1.*, c2.*
FROM Comments c1 LEFT OUTER JOIN Comments c2
ON c2.parent_id = c1.comment_id
```

#### 트리에서 4단계까지만 가져오는 쿼리

그 이상의 깊이에 있는 데이터는 가져오지 못한다.

```sql
SELECT c1.*, c2.*, c3.*, c4.*
FROM Comments c1
LEFT OUTER JOIN Comments c2
ON c1.comment_id = c2.parent_id
LEFT OUTER JOIN Comments c3
ON c1.comment_id = c3.parent_id
LEFT OUTER JOIN Comments c4
ON c1.comment_id = c4.parent_id
```

이러한 방식은 count() 같은 집계 수치를 계산하기에 어렵다.

데이터베이스에서 대량으로 데이터를 가져오는 방법은 엄청나게 비효율적이다. 전체 트리가 필요한게 아니라, 서브 트리만 필요할 수도 있기 때문이다.

### 안티패턴 인식 방법

- "트리에서 얼마나 깊은 단계를 지원해야 하지?"
- "트리 데이터 구조를 관리하는 코드는 건드리는 게 겁나"
- "트리에서 고아 노드를 정리하기 위해 주기적으로 스크립트를 돌려야 해"

### 안티패턴 사용이 합당한 경우

인접 목록이 애플리케이션에서 필요한 작업을 지원하는 데 적당할 수도 있다. 인접 목록의 강점은 주어진 노드의 부모나 자식을 바로 얻을 수 있다는 것이다.
또한 새로운 노드를 추가하기도 쉽다. 계층적 데이터로 작업하는 데 이 정도로만으로도 충분하다면, 인접 목록은 적절한 방법이다.

## 해법 : 대안 트리 모델 사용

계층적 데이터를 저장하는 데는 인접 목록 모델 외에도 `경로 열거(Path Enumeration)`, `중첩 집합(Nested Sets)`, `클로저 테이블(Closure Table)`과 같은 몇 가지 대안이 있다.

### 경로 열거(Path Enumeration)

인접 목록의 약점 중 하나는 트리에서 주어진 노드의 조상들을 얻는 데 비용이 많이 든다는 것이다. 경로 열거 방법에서는 일련의 조상을 각 노드의 속성으로 저장해 이를 해결한다.

디렉터리 구조에서도 경로 열거 형태를 볼 수 있다. /usr/local/lib 과 같은 UNIX 경로는 파일 시스템에서의 `경로 열거`이다. usr 은 local 의 부모고, local 은 lib 의 부모이다.

Comments 테이블에서 parent_id 컬럼 대신, 긴 varchar 타입의 path 란 컬럼을 정의한다. `/`를 구분자로 사용해도 된다.

```sql
CREATE TABLE Comments (
  comment_id SERIAL PRIMARY KEY,
  path VARCHAR(1000),
  bug_id BIGNINT UNSIGNED NOT NULL,
  author BIGINT UNSSIGNED NOT NULL,
  comment_date DATETIME NOT NULL,
  comment TEXT NOT NULL,
  FOREIGN KEY (bug_id) REFERENCES Bugs(bug_id),
  FOREIGN KEY (author) REFERENCES Accounts(account_id)
);
```
